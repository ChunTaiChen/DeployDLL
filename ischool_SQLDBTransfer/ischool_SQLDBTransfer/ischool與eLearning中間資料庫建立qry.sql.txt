-- ischool and eLearning中間資料交換DB
create database iSchoolDB;
go
use iSchoolDB;
go

--學生
create table student
(
	id int not null, --ischool學生系統編號，方便比對回去
	name nvarchar(20) not null, --中文姓名
	english_name nvarchar(30), --英文姓名
	id_number nvarchar(20), --身分證號
	login_name nvarchar(50) not null, --學生登入帳號
	ref_class_name nvarchar(50), --班級名稱，參考 class.class_name
	mailing_address nvarchar(100), --ischool聯絡地址(需解析XML組成完整地址)	
	email varchar(100), --學生email
	father_name nvarchar(20), --學生父親姓名(father_name)
	mother_name nvarchar(20), --學生母親姓名(mother_name)
	custodian_name nvarchar(20), --學生監護人姓名(custodian_name)
	father_mail varchar(100), --使用者自訂欄位
	mother_mail varchar(100), --使用者自訂欄位
	contact_phone varchar(50), --ischool聯絡電話(contact_phone)
	Constraint pk_student primary key(login_name,id)
)
go

-- 班級
create table class 
(
	id int not null, --ischoo班級編號，方便比對回去。
	class_name nvarchar(50) not null, --ischool班級名稱，國高中不重覆，可PK
	dsa_source nvarchar(50), --DSA 來源，參考dsa_source.name。康橋有國高中兩個DSA，需記錄來源，才能正確寫回 ischool
	Constraint pk_class primary key(class_name)
)
go

-- 教師
create table teacher
(
	teacher_name nvarchar(30), --教師姓名
	SSN nvarchar(20), --預設的密碼
	login_name nvarchar(50) not null,  --教師登入帳號
	Constraint pk_teacher primary key(login_name)
)
go
-- 課程
create table course
(
	id int, --ischool課程編號，當寫回ischool 時才會用到。
	course_name nvarchar(50) not null, --ischool課程名稱，國高中不重覆，可當PK
	school_year smallint not null, --學年度
	semester smallint not null, --學期
	credit int, --學分數
	ref_teacher_login_name nvarchar(50), --參照教師的登入帳號，對應 teacher.login_name
	dsa_source nvarchar(50), --DSA 來源
	Constraint uc_course unique(course_name,school_year,semester)
)
go
-- 課程定期評量項目
create table course_exam
(
	ref_course_name nvarchar(50) not null, --課程名稱，參考 course.course_name
	exam_name nvarchar(50) not null, --試別名稱
	ref_exam_id int, --試別編號，只用於寫回 ischool 時找出 exam_id 用。
	weight numeric, --權重
	Constraint uc_course_exam unique(ref_course_name,exam_name)
)
go
--學生修課紀錄
create table sc_attend
(
	ref_student_login_name nvarchar(50) not null, --學生帳號，參考 student.login_name
	ref_course_course_name nvarchar(50) not null, --課程名稱，參考 course.course_name
	eLearning_score numeric, --學期成績，由 eLearning 寫入
	ischool_score numeric, --學期成績，由 ischool 寫入
	Constraint uc_sc_attend unique(ref_student_login_name,ref_course_course_name)
)
go

--學生修課紀錄(給ischool暫存用)
create table sc_attend_ischool
(
	ref_student_login_name nvarchar(50) not null, --學生帳號，參考 student.login_name
	ref_course_course_name nvarchar(50) not null, --課程名稱，參考 course.course_name
	eLearning_score numeric, --學期成績，由 eLearning 寫入
	ischool_score numeric, --學期成績，由 ischool 寫入
	Constraint uc_sc_attend_ischool unique(ref_student_login_name,ref_course_course_name)
)
go

--學生定期評量成績
create table sce_take
(
	ref_student_login_name nvarchar(50) not null, --學生帳號，參考 student.login_name
	ref_course_course_name nvarchar(50) not null, --課程名稱，參考 course.course_name
	ref_exam_name nvarchar(50) not null, --試別名稱，參考 course_exam.exam_name
	score numeric, --定期評量成績
	quiz_score numeric, --平時評量成績
	text_score ntext, --文字評量
	Constraint uc_sce_take unique(ref_student_login_name,ref_course_course_name,ref_exam_name)
)
go
--學生缺曠 -elearning
create table attendance
(
	ref_student_login_name nvarchar(50) not null, --學生帳號，參考 student.login_name
	occur_date datetime not null, --發生日期
	detail ntext not null, --缺曠詳細資料(XML)
	last_update datetime not null --最後更新日期
	
)
go

--學生缺曠 ischool 寫入
create table attendance_ischool
(
	ref_student_login_name nvarchar(50), --學生帳號，參考 student.login_name
	occur_date datetime, --發生日期
	detail ntext--缺曠詳細資料(XML)		
)
go
--資料轉換結果紀錄
create table transfer_summary
(
	id int primary key identity, --自動編號
	begin_time datetime not null, --開始時間
	end_time datetime not null, --結束時間
	transfer_step int not null, --轉換步驟。1:由 eLearning寫入DB     2. 由DB寫入 ischool   3.由 ischool 寫入 DB   4. 由 DB 寫入 eLearning
	is_successful bit not null, --是否成功？0:否, 1:是
	summary ntext not null --轉檔摘要記錄，內容由開發者自定
)
go
-- 小考項目
create table quiz_item
(
	id int primary key, --PK
	ref_course_name nvarchar(50) not null, --課程名稱，參考 course.course_name
	ref_exam_name nvarchar(50) not null, --定期評量名稱，參考  course_exam.exam_name
	quiz_name nvarchar(50) not null, --小考名稱
	weight decimal not null, --權重
	Constraint uc_quiz_item unique(ref_course_name,ref_exam_name,quiz_name)
)
go
-- 小考成績
create table quiz_score
(
	ref_student_login_name nvarchar(50) not null, --學生帳號，參考 student.login_name
	ref_quiz_item_id int not null, --小考項目編號，參考 quiz_item.id
	score numeric, --小考分數
	Constraint uc_quiz_score unique(ref_student_login_name,ref_quiz_item_id)
)
go

/* -- create sc_attend store procedure
 create procedure sp_InsertOrUpdate_sc_attend
@LoginName nvarchar(50),
@CourseName nvarchar(50),
@Score numeric
as
if exists(select * from sc_attend where ref_student_login_name=@LoginName and ref_course_course_name=@CourseName)
update sc_attend set ischool_score=@Score where ref_student_login_name=@LoginName and ref_course_course_name=@CourseName;
else
insert into sc_attend (ref_student_login_name,ref_course_course_name,ischool_score) values(@LoginName,@CourseName,@Score); */


-- ischool 資料來源(XML描述取代)
--create table dsa_source
--(
--	name nvarchar(50), --ischool 來源名稱，康橋有高中、國中等兩個DSA source。
--	dsns_name nvarchar(50) --DSNS 名稱，如 h.kcbc.ntpc.edu.tw
--)
--go
